---
title: "autotest"
author: 
  - "Mark Padgham"
date: "`r Sys.Date()`"
output: 
    html_document:
        toc: true
        toc_float: true
        number_sections: false
        theme: flatly
vignette: >
  %\VignetteIndexEntry{autotest}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = TRUE,
  message = TRUE,
  width = 120,
  comment = "#>",
  fig.retina = 2,
  fig.path = "README-"
)
```

This vignette extends from the main
[`README`](https://ropenscilabs.github.io/autotest/) document by providing
a demonstration of applying `autotest` to a package. By default the
[`autotest_package()`
function](https://ropenscilabs.github.io/autotest/reference/autotest_package.html)
tests an entire package, but testing can also be restricted to specified
functions only. This vignette will demonstrate application to a few functions
from the 
[`stats`
package](https://stat.ethz.ch/R-manual/R-devel/library/stats/html/00Index.html).

```{r pkg-load, echo = FALSE}
library (autotest)
```


## `.Rd` files, example code, and the autotest workflow

To understand what `autotest` does, it is first necessary to understand a bit
about the structure of documentation files for R package, which are contained
in files called `".Rd"` files. Tests are constructed by parsing individual
`.Rd` documentation files to extract the example code, identifying parameters
passed to the specified functions, and mutating those parameters.

The general procedure can be illustrated by examining a specific function, for
which we now choose the [`cor`
function](https://stat.ethz.ch/R-manual/R-devel/library/stats/html/cor.html),
primarily because both inputs and outputs are relatively simple. The following
lines gets that content for the `cor` function, noting that the above link
reveals the name of the `.Rd` file to be "cor", meaning that the name of the
`.Rd` file is `"cor.Rd"`. The first line extracts the entire `.Rd` database for
the [`stats`
package](https://stat.ethz.ch/R-manual/R-devel/library/stats/html/00Index.html).

```{r cor-rd}
rd <- tools::Rd_db (package = "stats")
cor_rd <- rd [[grep ("^cor\\.Rd", names (rd))]]
```

The database itself is a list, with each entry holding the contents of one
`.Rd` file in an object of class `r class(cor_rd)`, which is essentially
a large nested
list of components corresponding to the various `.Rd` tags such as
`\arguments`, `\details`, and `\value`. An internal function from the [`tools`
package](https://stat.ethz.ch/R-manual/R-devel/library/tools/html/00Index.html)
can be used to extract individual components (using the `:::` notation to
access internal functions). For example, a single `.Rd` file often describes
the functionality of several functions, each of which is identified by
specifying the function name as an `"alias"`. The aliases for the `"cor.Rd"`
file are:

```{r cor-aliases}
tools:::.Rd_get_metadata (cor_rd, "alias")
```

This one file thus contains documentation for those four functions. Example
code can be extracted with a dedicated function from the [`tools`
package](https://stat.ethz.ch/R-manual/R-devel/library/tools/html/00Index.html):

```{r Rd2ex-dummy, echo = TRUE, eval = FALSE}
tools::Rd2ex (cor_rd)
```
```{r Rd2ex-dummy, echo = FALSE, eval = TRUE}
tools::Rd2ex (cor_rd)
```

`autotest` then tests the example code from a single `.Rd` file according to
the following general steps:

1. Extract example lines from the `.Rd` file, as demonstrated above;
2. Identify all points at which functions specified as aliases in the `.Rd` file are called;
3. Identify all objects passed to those values, including values, classes,
   attributes, and other properties, as well as parameters not included in
   example code but identifiable by default values;
4. Mutate those values according to the kinds of test described in
   [`autotest_types()`](https://ropenscilabs.github.io/autotest/reference/autotest_types.html).


## autotesting the `stats::cov` function

The first step in an `autotest` workflow is to call the [`autotest_package()`
function](https://ropenscilabs.github.io/autotest/reference/autotest_package.html),
optionally restricted to some specified sub-set of functions. The following
demonstrates the results for the `cor` function:

```{r at-cor-notest-dummy, echo = TRUE, eval = FALSE}
x0 <- autotest_package (package = "stats", functions = "cor")
```
```{r at-cor-notest, fig.show = "hide", collapse = TRUE, echo = FALSE}
x0 <- autotest_package (package = "stats", functions = "cor")
```

That reveals that the example code from the `.Rd` file has four main points at
which the aliases defined in that file are tested: once each for `var` and
`cor`, and twice for `cov`. The result looks like this:

```{r print-x-dummy, echo = TRUE, eval = FALSE}
print (x0)
```
```{r print-x, echo = FALSE, collapse = TRUE}
print (x0)
```


The [`autotest_package()`
function](https://ropenscilabs.github.io/autotest/reference/autotest_package.html)
has a `test` parameter with a default value of `test = FALSE`, meaning that no
mutation tests are actually conducted. This means in turn that simply calling
the function on a specified package like was done above, or subset of functions
thereof, will return data on tests which would be performed on that package or
those functions, without actually running the tests. This in indicated in the
results by values for `type` (the first column) of `"dummy"`. Calling the
function with `test = TRUE` would apply a total of `r nrow(x)` tests to those
four functions. Doing so yields the following results:

```{r at-cor-test-dummy, echo = TRUE, eval = FALSE}
x1 <- autotest_package (package = "stats", functions = "cor", test = TRUE)
```
```{r at-cor-test, fig.show = "hide", collapse = TRUE, echo = FALSE}
x1 <- autotest_package (package = "stats", functions = "cor", test = TRUE)
```
```{r print-x1-dummy, echo = TRUE, eval = FALSE}
print (x1)
```
```{r print-x1, echo = FALSE, collapse = TRUE}
print (x1)
```
